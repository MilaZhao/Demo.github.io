<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>åº·å¯¶å»šè—æ™‚ä»£ Knorr Pro v40</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0..1,0" />
    <style>
        /* =========================================
           ğŸ¨ DESIGN TOKENS SYSTEM
           ========================================= */
        :root {
            /* --- 1. Color Palette --- */
            --color-primary: #00652B;
            --color-primary-dark: #004d20;
            --color-primary-light: #E6F0EA;
            --color-secondary: #FF5700;
            --color-secondary-light: #FFF0E5;
            
            --color-success: #4CAF50;
            --color-warning: #FFD700;
            --color-danger: #d32f2f;
            --color-danger-bg: #ffebee;
            --color-info: #E3F2FD;
            --color-info-text: #1565C0;

            /* Social Colors */
            --color-line: #06C755;
            --color-apple: #000000;

            --color-bg-body: #F7F9F8;
            --color-surface: #FFFFFF;
            --color-surface-muted: #F9F9F9;
            --color-border: #EEEEEE;
            --color-text-main: #2D3330;
            --color-text-body: #4A524F;
            --color-text-muted: #8C9692;
            --color-text-light: #FFFFFF;
            --color-text-placeholder: #CCCCCC;

            /* --- 2. Spacing Scale --- */
            --space-2xs: 4px;
            --space-xs: 8px;
            --space-sm: 12px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 60px;

            /* --- 3. Typography Scale --- */
            --text-2xs: 10px;
            --text-xs: 12px;
            --text-sm: 14px;
            --text-base: 16px;
            --text-lg: 18px;
            --text-xl: 20px;
            --text-2xl: 22px;
            --text-3xl: 24px;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

            /* --- 4. Border Radius --- */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;

            /* --- 5. Elevation --- */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 8px 24px rgba(0,101,43,0.08);
            --shadow-lg: 0 12px 32px rgba(0,0,0,0.12);
            --shadow-up: 0 -4px 12px rgba(0,0,0,0.08);

            /* --- 6. Layout Constants --- */
            --header-height: 56px;
            --bottom-nav-height: 80px;
            --z-header: 90;
            --z-modal: 2000;
            --z-toast: 3000;
        }

        /* =========================================
           CORE STYLES
           ========================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--color-bg-body); 
            color: var(--color-text-main); 
            font-family: var(--font-main); 
            padding-bottom: var(--bottom-nav-height); 
            line-height: 1.6; 
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            transition: font-variation-settings 0.3s ease;
        }

        /* --- Components: Header --- */
        header { background: var(--color-surface); position: sticky; top: 0; z-index: var(--z-header); box-shadow: var(--shadow-sm); }
        .header-top { background: var(--color-primary); padding: var(--space-xs) var(--space-md); height: var(--header-height); display: flex; align-items: center; gap: var(--space-md); color: var(--color-text-light); }
        .search-bar { flex: 1; background: rgba(255,255,255,0.15); border-radius: 30px; height: 36px; display: flex; align-items: center; padding: 0 var(--space-md); font-size: var(--text-sm); }
        .icon-btn { cursor: pointer; color: var(--color-text-light); }

        /* --- Components: Tabs --- */
        .tab-bar { padding: var(--space-sm) 0; background: var(--color-surface); border-bottom: 1px solid var(--color-border); }
        .scrolling-wrapper { display: flex; overflow-x: auto; gap: var(--space-xs); padding: 0 var(--space-md); scrollbar-width: none; }
        .tab-chip { padding: 6px var(--space-md); border-radius: 20px; font-size: 13px; font-weight: 500; color: var(--color-text-muted); background: var(--color-surface-muted); white-space: nowrap; transition: 0.2s; cursor: pointer; border: 1px solid transparent; }
        .tab-chip.active { background: var(--color-primary-light); color: var(--color-primary); font-weight: 700; border-color: rgba(0,101,43,0.2); }

        /* --- Components: Sections --- */
        .section-header { padding: var(--space-lg) var(--space-md) var(--space-sm); display: flex; justify-content: space-between; align-items: center; }
        .section-title { font-size: var(--text-lg); font-weight: 700; display: flex; align-items: center; gap: var(--space-xs); }
        .card-scroll-container { display: flex; overflow-x: auto; gap: var(--space-md); padding: 0 var(--space-md) var(--space-md); scrollbar-width: none; }
        
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Components: Cards (Standard) --- */
        .card { background: var(--color-surface); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; cursor: pointer; position: relative; min-width: 220px; }
        .card:active { transform: scale(0.98); transition: 0.1s; }
        .card-img-wrapper { position: relative; padding-top: 60%; background: #eee; }
        .card-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .card-badge { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); color: white; font-size: var(--text-2xs); font-weight: 700; padding: 4px 8px; border-radius: 4px; z-index: 2; }
        .card-content { padding: var(--space-sm); flex: 1; display: flex; flex-direction: column; }
        .card-title { font-weight: 700; font-size: 15px; margin-bottom: var(--space-xs); line-height: 1.3; }
        .card-meta { display: flex; gap: 4px; flex-wrap: wrap; margin-top: auto; }
        .meta-tag { font-size: var(--text-2xs); background: #F0F2F1; padding: 2px 6px; border-radius: 4px; color: #666; display: flex; align-items: center; gap: 2px; }
        .card-bottom-info { margin-top: 8px; border-top: 1px solid #f5f5f5; padding-top: 6px; font-size: 10px; color: var(--color-text-muted); display: flex; align-items: center; gap: 4px; }

        /* --- Components: List Cards --- */
        .list-card { background: var(--color-surface); margin: 0 var(--space-md) var(--space-sm); padding: var(--space-md); border-radius: var(--radius-md); box-shadow: var(--shadow-sm); display: flex; gap: var(--space-md); align-items: flex-start; cursor: pointer; position: relative; }
        .list-card-img { width: 80px; height: 80px; border-radius: var(--radius-sm); object-fit: cover; background: #eee; flex-shrink: 0; }
        
        .rank-badge { position: absolute; top: 0; left: 0; width: 24px; height: 24px; border-radius: var(--radius-md) 0 var(--radius-md) 0; display: flex; justify-content: center; align-items: center; font-weight: 900; font-size: var(--text-xs); color: #fff; z-index: 2; }
        .rank-1 { background: var(--color-warning); color: #333; }
        .rank-2 { background: #C0C0C0; color: #333; }
        .rank-3 { background: #CD7F32; }
        
        .ranking-meta-row { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-text-muted); margin-top: 6px; }
        
        .btn-save-mini { width: 32px; height: 32px; border-radius: 50%; border: 1.5px solid #ddd; background: white; display: flex; justify-content: center; align-items: center; color: #ccc; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 5; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-save-pos { position: absolute; top: 8px; right: 8px; }
        .list-save-pos { position: absolute; bottom: 12px; right: 12px; }
        .btn-save-mini .material-symbols-outlined { font-size: 18px; color: #999; transition: color 0.3s; }
        .btn-save-mini.active { border-color: var(--color-secondary); background: white; transform: scale(1.15); box-shadow: 0 4px 12px rgba(255, 87, 0, 0.25); }
        .btn-save-mini.active .material-symbols-outlined { color: var(--color-secondary); font-variation-settings: 'FILL' 1; }
        .btn-save-mini:active { transform: scale(0.95); }

        .ranking-tabs { display: flex; border-bottom: 1px solid var(--color-border); margin-bottom: var(--space-sm); }
        .ranking-tab { flex: 1; text-align: center; padding: var(--space-sm); font-size: var(--text-sm); color: var(--color-text-muted); cursor: pointer; border-bottom: 2px solid transparent; }
        .ranking-tab.active { color: var(--color-primary); font-weight: 700; border-color: var(--color-primary); }

        /* --- Components: Banners & Buttons --- */
        .chef-banner { margin: var(--space-md); background: linear-gradient(135deg, #1a1a1a, #333); border-radius: var(--radius-lg); padding: 20px; color: white; display: flex; align-items: center; justify-content: space-between; overflow: hidden; position: relative; box-shadow: var(--shadow-md); cursor: pointer; }
        .chef-banner::after { content:''; position:absolute; right:-20px; top:-20px; width:100px; height:100px; background:var(--color-secondary); border-radius:50%; opacity:0.15; }
        
        .strategy-cta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm); padding: 0 var(--space-md) var(--space-xs); margin-bottom: var(--space-xs); }
        .strategy-btn { background: var(--color-surface); border-radius: var(--radius-lg); padding: var(--space-md); display: flex; flex-direction: column; align-items: center; gap: var(--space-xs); box-shadow: var(--shadow-sm); cursor: pointer; border: 1px solid #f0f0f0; transition:0.1s;}
        .strategy-btn:active { transform: scale(0.98); background: #fafafa; }
        .btn-icon-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: var(--text-3xl); margin-bottom: 4px; }
        .btn-change .btn-icon-circle { background: var(--color-info); color: var(--color-info-text); }
        .btn-fast .btn-icon-circle { background: var(--color-secondary-light); color: var(--color-secondary); }
        .recipe-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); padding: 0 var(--space-md) var(--space-lg); }

        /* --- Components: Scan & Profile --- */
        .scan-container { height: calc(100vh - 80px); background: #121212; display: flex; flex-direction: column; position: relative; }
        .scan-viewfinder { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .scan-frame { width: 260px; height: 260px; border: 2px solid var(--color-secondary); border-radius: var(--radius-xl); position: relative; box-shadow: 0 0 0 4000px rgba(0,0,0,0.7); }
        .scan-frame::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--color-secondary); box-shadow: 0 0 10px var(--color-secondary); animation: scanMove 2s infinite linear; }
        @keyframes scanMove { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        .scan-controls { position: absolute; top: 20px; right: 20px; z-index: 10; }
        .toggle-btn { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 20px; color: white; font-size: var(--text-xs); font-weight: 600; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .toggle-switch { width: 32px; height: 18px; background: rgba(0,0,0,0.3); border-radius: 10px; position: relative; transition: 0.3s; border:1px solid rgba(255,255,255,0.5); }
        .toggle-switch.on { background: var(--color-secondary); border-color:var(--color-secondary); }
        .toggle-switch::after { content:''; position: absolute; top: 2px; left: 2px; width: 12px; height: 12px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-switch.on::after { transform: translateX(14px); }
        .rewards-panel { background: white; border-radius: 24px 24px 0 0; padding: 24px 20px; z-index: 10; }
        .progress-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
        .progress-track { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-bottom: 20px; margin-top: 8px; }
        .progress-fill { width: 85%; height: 100%; background: linear-gradient(90deg, var(--color-primary), var(--color-success)); border-radius: 4px; }
        .instant-rewards { display: flex; gap: 12px; }
        .reward-card { flex: 1; border: 1px solid #eee; padding: 12px; border-radius: var(--radius-md); text-align: center; cursor: pointer; transition: 0.2s; }
        .reward-card:active { border-color: var(--color-primary); background: var(--color-primary-light); }
        .toast { position: absolute; bottom: 200px; left: 50%; transform: translateX(-50%); background: rgba(0, 101, 43, 0.95); color: white; padding: 12px 24px; border-radius: 30px; font-size: var(--text-sm); font-weight: 600; display: flex; align-items: center; gap: 8px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: var(--z-toast); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        /* --- Components: Profile --- */
        .profile-bg { background: linear-gradient(180deg, var(--color-primary) 0%, var(--color-primary-dark) 100%); padding: var(--space-xl) 20px 80px; color: white; border-radius: 0 0 32px 32px; }
        .profile-user { display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-lg); }
        .profile-avatar { width: 72px; height: 72px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 32px; font-weight: 700; color: var(--color-primary); border: 4px solid rgba(255,255,255,0.2); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .profile-card { background: white; border-radius: 20px; padding: 24px; margin: -60px var(--space-md) 20px; box-shadow: var(--shadow-md); position: relative; }
        
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md); }
        .menu-btn { background: #ffffff; border: 1px solid #f0f0f0; padding: 20px; border-radius: var(--radius-lg); text-align: center; cursor: pointer; transition: 0.2s; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; align-items: center; gap: var(--space-xs); }
        .menu-btn:active { transform: scale(0.96); background: var(--color-surface-muted); }
        .menu-btn-icon { width: 48px; height: 48px; border-radius: 50%; background: var(--color-primary-light); color: var(--color-primary); display: flex; justify-content: center; align-items: center; font-size: 24px; }
        
        .support-btn { background: var(--color-info); color: var(--color-info-text); padding: var(--space-md); border-radius: var(--radius-lg); display: flex; justify-content: center; align-items: center; gap: 8px; margin: 0 var(--space-md) var(--space-md); cursor: pointer; font-weight: 700; }
        .logout-btn { background: var(--color-danger-bg); color: var(--color-danger); padding: var(--space-md); border-radius: var(--radius-lg); display: flex; justify-content: center; align-items: center; gap: 8px; margin: 0 var(--space-md) var(--space-xl); cursor: pointer; font-weight: 700; border: 1px solid #ffcdd2; }

        /* --- Components: Modals & Overlays --- */
        #wizard-overlay, #reg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: var(--z-modal); display: none; justify-content: center; align-items: flex-end; backdrop-filter: blur(4px); }
        .wizard-container, .reg-container { background: var(--color-surface); width: 100%; border-radius: 24px 24px 0 0; padding: 32px 24px; max-height: 90vh; overflow-y: auto; position: relative; animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .wizard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); }
        .wizard-progress { display: flex; gap: 6px; margin-bottom: var(--space-lg); }
        .progress-bar { height: 6px; flex: 1; background: #f0f0f0; border-radius: 3px; transition: 0.3s; }
        .progress-bar.active { background: var(--color-secondary); }
        .wizard-option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm); }
        
        /* Optimized Survey Card Option */
        .survey-card { 
            padding: 16px; 
            border: 2px solid #f0f0f0; 
            border-radius: var(--radius-lg); 
            cursor: pointer; 
            transition: 0.2s; 
            background: #fff; 
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .survey-card:active { border-color: var(--color-primary); background: var(--color-primary-light); transform: scale(0.98); }
        .survey-icon { font-size: 24px; color: var(--color-secondary); background: var(--color-secondary-light); padding: 8px; border-radius: 50%; }
        .survey-text-group { flex: 1; }
        .survey-title { font-weight: 700; font-size: 15px; color: var(--color-text-main); margin-bottom: 2px; }
        .survey-sub { font-size: 11px; color: var(--color-text-muted); }

        .wizard-option { padding: 20px; border: 2px solid #f0f0f0; border-radius: var(--radius-lg); text-align: center; font-weight: 700; color: var(--color-text-body); cursor: pointer; transition: 0.2s; background: #fff; font-size: var(--text-base); }
        .wizard-option:active { border-color: var(--color-primary); background: var(--color-primary-light); color: var(--color-primary); transform: scale(0.98); }
        .result-context { background: var(--color-primary-light); padding: 20px; margin: var(--space-md); border-radius: var(--radius-lg); display: flex; flex-direction: column; gap: var(--space-sm); border: 1px solid rgba(0,101,43,0.1); }
        .result-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .result-chip { background: white; color: var(--color-text-body); padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; border: 1px solid rgba(0,0,0,0.05); }

        /* --- Social Login Buttons --- */
        .btn-social { width: 100%; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; border: none; cursor: pointer; margin-bottom: 12px; transition: 0.2s; box-shadow: var(--shadow-sm); }
        .btn-social:active { transform: scale(0.98); opacity: 0.9; }
        .btn-apple { background: var(--color-apple); color: white; }
        .btn-line { background: var(--color-line); color: white; }
        .btn-phone { background: white; color: var(--color-text-main); border: 1px solid #ddd; }

        /* --- Components: Guest & Hook --- */
        .guest-chips-container { padding: 4px var(--space-md) 8px; background: var(--color-primary); display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; color: white; margin-bottom: 0; }
        .guest-chip { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 16px; font-size: var(--text-xs); white-space: nowrap; cursor: pointer; border:1px solid transparent; }
        .guest-chip.active { background: white; color: var(--color-primary); font-weight: 700; }
        
        .hook-card { margin: var(--space-md); background: linear-gradient(135deg, #FF9800, #F57C00); border-radius: var(--radius-lg); padding: 20px; color: white; position: relative; overflow: hidden; box-shadow: var(--shadow-md); cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .hook-card::before { content:''; position:absolute; top:-50%; left:-10%; width:100%; height:200%; background:rgba(255,255,255,0.1); transform:rotate(30deg); }
        .hook-content { position: relative; z-index: 2; flex:1; }
        .hook-title { font-size: var(--text-lg); font-weight: 800; margin-bottom: 4px; }
        .hook-sub { font-size: var(--text-xs); opacity: 0.9; }
        
        .reg-input { width: 100%; padding: 16px; border: 1px solid #ddd; border-radius: var(--radius-md); margin-bottom: 16px; font-size: var(--text-base); outline: none; transition: 0.2s; }
        .reg-input:focus { border-color: var(--color-primary); }
        .btn-reg-action { width: 100%; padding: 16px; background: var(--color-primary); color: white; border: none; border-radius: 30px; font-size: var(--text-base); font-weight: 700; cursor: pointer; }
        .reg-benefits { background: var(--color-surface-muted); padding: 16px; border-radius: var(--radius-md); margin-bottom: 24px; }
        .reg-benefit-item { display: flex; gap: 8px; font-size: 13px; margin-bottom: 8px; align-items: center; color: #555; }

        /* --- Components: Detail View --- */
        #detail-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--color-surface); z-index: 3000; overflow-y: auto; display: none; }
        .detail-hero { height: 320px; position: relative; }
        .detail-hero img { width: 100%; height: 100%; object-fit: cover; }
        .detail-back { position: fixed; top: 24px; left: 20px; width: 44px; height: 44px; background: rgba(255,255,255,0.95); border-radius: 50%; display: flex; justify-content: center; align-items: center; z-index: 3010; cursor: pointer; box-shadow: var(--shadow-md); }
        
        .detail-body { padding: var(--space-xl) var(--space-lg); background: white; border-radius: 32px 32px 0 0; margin-top: -40px; position: relative; min-height: 80vh; padding-bottom: 120px; }
        
        .progress-bar-top { position: fixed; top: 0; left: 0; width: 100%; height: 6px; background: #eee; z-index: 3020; display:none; }
        .progress-bar-fill { height: 100%; background: var(--color-primary); width: 0%; transition: width 0.1s; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-lg); }
        .info-box { background: #FAFAFA; border: 1px solid #EEE; border-radius: var(--radius-lg); padding: 16px 12px; text-align: center; }
        .info-label { font-size: var(--text-xs); color: #888; margin-bottom: 4px; }
        .info-value { font-weight: 700; color: #333; }

        .section-header-detail { font-size: var(--text-lg); font-weight: 700; color: var(--color-text-main); margin: var(--space-xl) 0 var(--space-md); display: flex; align-items: center; gap: 8px; padding-left: 12px; border-left: 4px solid var(--color-secondary); }
        
        .checkbox-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f9f9f9; cursor: pointer; }
        .checkbox-left { display: flex; align-items: center; gap: 12px; }
        .checkbox-circle { width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 50%; transition: 0.2s; position: relative; flex-shrink: 0; }
        .checkbox-circle.checked { background: var(--color-primary); border-color: var(--color-primary); }
        .checkbox-circle.checked::after { content:'âœ“'; color:white; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:12px; }
        .ing-amount { font-weight: 700; color: var(--color-text-body); transition: color 0.3s; }
        .ing-amount.changed { color: var(--color-secondary); animation: pulse 0.5s; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .tag-row { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
        .detail-tag { font-size: 12px; color: var(--color-primary); background: var(--color-primary-light); padding: 4px 12px; border-radius: 20px; font-weight: 600; }

        .portion-control { display: flex; align-items: center; justify-content: space-between; background: var(--color-surface-muted); border-radius: var(--radius-md); padding: 8px 16px; margin-bottom: 24px; }
        .portion-btn { width: 32px; height: 32px; background: white; border-radius: 50%; border: 1px solid #ddd; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--color-primary); font-weight: bold; user-select: none; }
        .portion-btn:active { background: var(--color-primary-light); }
        .portion-display { font-weight: 700; font-size: 16px; display: flex; flex-direction: column; align-items: center; line-height: 1.2; }
        .portion-label { font-size: 10px; color: #888; }
        
        .rp-card { min-width: 130px; border: 1px solid #eee; border-radius: var(--radius-md); padding: 12px; text-align: center; cursor: pointer; transition: 0.2s; background: white; }
        .rp-card:active { border-color: var(--color-primary); transform: scale(0.98); background: #FAFAFA; }
        .rp-img { width: 100%; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; }

        .detail-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; box-shadow: var(--shadow-up); padding: 16px 24px; display: flex; gap: 12px; z-index: 3020; padding-bottom: max(16px, env(safe-area-inset-bottom)); }
        .btn-outline { flex: 1; border: 1px solid var(--color-primary); color: var(--color-primary); background: white; border-radius: 30px; height: 48px; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-primary { flex: 1; background: var(--color-primary); color: white; border: none; border-radius: 30px; height: 48px; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,101,43,0.3); }

        /* Notes Section */
        .note-area { width: 100%; min-height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: var(--radius-md); font-family: inherit; margin-top: 8px; font-size: 14px; background: #fffcf5; color: #444; }
        .note-area:focus { border-color: var(--color-secondary); outline: none; box-shadow: 0 0 0 2px rgba(255,87,0,0.1); }
        .btn-save-note { margin-top: 8px; background: var(--color-secondary); color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; float: right; cursor: pointer; }

        /* Comments */
        .comment-section { margin-top: 40px; border-top: 1px solid #eee; padding-top: 24px; }
        .comment-item { display: flex; gap: 16px; margin-bottom: 24px; border-bottom: 1px solid #f5f5f5; padding-bottom: 16px; }
        .comment-avatar { width: 40px; height: 40px; background: #81C784; color:white; border-radius: 50%; display:flex; justify-content:center; align-items:center; font-weight:700; flex-shrink:0; }
        .comment-body { flex: 1; }
        .comment-name { font-weight: 700; font-size: 14px; margin-bottom: 2px; }
        .comment-meta { font-size: 12px; color: #777; display: flex; gap: 8px; margin-bottom: 8px; }
        .comment-stars { color: #FBC02D; letter-spacing: 1px; }
        .comment-text { font-size: 14px; color: #444; line-height: 1.5; }
        .comment-actions { margin-top: 12px; display: flex; gap: 12px; }
        .action-chip { font-size: 12px; color: #555; border: 1px solid #ddd; padding: 4px 12px; border-radius: 16px; display: flex; align-items: center; gap: 4px; cursor: pointer; transition: 0.2s; }
        .action-chip:active { background: #f0f0f0; }

        .comment-input-area { background: var(--color-surface-muted); padding: 4px 4px 4px 16px; border-radius: 24px; display: flex; align-items: center; margin-top: 16px; border: 1px solid transparent; transition: 0.2s; }
        .comment-input-area:focus-within { border-color: var(--color-primary); background: white; box-shadow: 0 0 0 4px rgba(0,101,43,0.1); }
        .btn-submit { background: var(--color-primary); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; margin-left: 8px; flex-shrink: 0; }
        .btn-submit.editing { background: var(--color-secondary); }

        .product-rec-container { padding: 16px 0 32px; }
        .product-card-sm { background: var(--color-surface-muted); border-radius: var(--radius-md); padding: 12px; display: flex; align-items: center; gap: 12px; border: 1px solid #EEE; margin-bottom: 12px; cursor: pointer; }
        .product-card-sm img { width: 48px; height: 48px; object-fit: contain; }

        /* Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height); background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); border-top: 1px solid #eee; display: flex; justify-content: space-around; padding-top: 12px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: var(--color-text-muted); cursor: pointer; flex: 1; transition: 0.2s; }
        .nav-item.active { color: var(--color-primary); }
        .nav-icon-container { width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; }
        .scan-circle-icon { width: 32px; height: 32px; background: var(--color-primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 8px rgba(0,101,43,0.3); }

    </style>
</head>
<body>

    <div id="app-root"></div>

    <div id="wizard-overlay">
        <div class="wizard-container">
            <div class="wizard-header">
                <span class="wizard-title" id="wizard-title" style="font-size:20px;font-weight:700;"></span>
                <span class="material-symbols-outlined" onclick="closeWizard()" style="cursor:pointer;padding:8px;">close</span>
            </div>
            <div class="wizard-progress" id="wizard-progress" style="display:flex;gap:6px;margin-bottom:24px;"></div>
            <div id="wizard-content"></div>
            <div id="wizard-loading" style="display:none; text-align:center; padding:60px 0;">
                <span class="material-symbols-outlined" style="font-size:56px; color:var(--color-secondary); animation:spin 1s linear infinite;">progress_activity</span>
                <p style="font-weight:700; color:var(--color-primary); margin-top:24px; font-size:18px;">æ­£åœ¨æ¨è–¦æœ€ä½³æ–¹æ¡ˆ</p>
                <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
            </div>
        </div>
    </div>

    <div id="reg-overlay">
        <div class="reg-container">
            <div class="wizard-header">
                <span style="font-size:20px;font-weight:700;">ğŸ’¼ æ­¡è¿åŠ å…¥åº·å¯¶å»šè—æ™‚ä»£</span>
                <span class="material-symbols-outlined" onclick="closeReg()" style="cursor:pointer;padding:8px;">close</span>
            </div>
            
            <div id="reg-step-container"></div>
        </div>
    </div>

    <div id="detail-view" onscroll="updateProgress()">
        <div class="progress-bar-top"><div class="progress-bar-fill" id="read-progress"></div></div>
        <div class="detail-back" onclick="closeDetail()"><span class="material-symbols-outlined">arrow_back</span></div>
        <div class="detail-hero"><img id="detail-img" src=""></div>
        <div class="detail-body" id="detail-content"></div>
        <div id="detail-footer-slot"></div> 
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="router('home')"><span class="material-symbols-outlined">home</span><span style="font-size:10px;">é¦–é </span></div>
        <div class="nav-item" onclick="router('info')"><span class="material-symbols-outlined">article</span><span style="font-size:10px;">é¤é£²æƒ…å ±</span></div>
        <div class="nav-item" onclick="router('scan')">
            <div class="scan-circle-icon"><span class="material-symbols-outlined" style="font-size:20px;">qr_code_scanner</span></div>
            <span style="font-size:10px;font-weight:700;color:var(--color-primary);margin-top:2px;">é›†é»</span>
        </div>
        <div class="nav-item" onclick="router('recipes')"><span class="material-symbols-outlined">menu_book</span><span style="font-size:10px;">å°ˆæ¥­é£Ÿè­œ</span></div>
        <div class="nav-item" onclick="router('shop')"><span class="material-symbols-outlined">shopping_cart</span><span style="font-size:10px;">è³¼è²·</span></div>
    </nav>

    <script>
        // --- Global State ---
        let userState = 'guest'; // 'guest' or 'member'
        let userPrefs = { goal: '', type: '', role: '' };
        const guestInterests = ['ğŸ”¥ å·èœ', 'ğŸ± å•†æ¥­åˆé¤', 'ğŸ¥© èˆ’è‚¥æ‡‰ç”¨', 'ğŸœ éºµé£Ÿ'];

        // --- Data ---
        const db = {
            recipes: [
                { id: 1, title: "éº»è¾£æ°´ç…®é­š", category: ["all","chef","spicy"], tags: ["#å·èœç¶“å…¸", "#å†¬å­£é™å®š", "#é«˜åˆ©æ½¤"], type: "åå»š", date: "2024/01/12", views: "3.2k", img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/recipes/TW-recipes/general/%E9%BA%BB%E8%BE%A3%E6%B0%B4%E7%85%AE%E9%AD%9A/CR2024Traditional003%20(2).jpg", 
                  stats: {time: "15åˆ†", cost: "$45", diff: "ä¸­"}, ranking: 1, reviews: 24, baseServings: 10, isSaved: true, note: "é€™é“èœéå¹´å¯ä»¥æ¨ï¼Œé­šç‰‡è¦åšä¸€é»ã€‚",
                  desc: "æ±ŸæŒ¯èª ä¸»å»šæ¨è–¦æŠ€æ³•ï¼Œé€éä½æº«æ…¢ç…®é–ä½è‚‰æ±ï¼Œæ­é…åº·å¯¶éº»è¾£é†¬èˆ‡ç‰¹è£½èŠ±æ¤’æ²¹ï¼Œå‘ˆç¾å¤šå±¤æ¬¡é¦™æ°£ã€‚",
                  ingredients: [ {name: "é±¸é­šç‰‡", amount: 400, unit: "g"}, {name: "è±†èŠ½èœ", amount: 200, unit: "g"}, {name: "åº·å¯¶éº»è¾£é†¬", amount: 3, unit: "å¤§åŒ™"}, {name: "åº·å¯¶é›ç²‰", amount: 1, unit: "å°åŒ™"}, {name: "èŠ±æ¤’ç²’", amount: 1, unit: "å¤§åŒ™"} ],
                  steps: [{t:"é†ƒè£½",c:"é±¸é­šç‰‡åˆ‡è–„ç‰‡ï¼Œç”¨é¹½ã€å¤ªç™½ç²‰é†ƒè£½10åˆ†é˜ã€‚"}, {t:"ç‚’é†¬ç…®æ¹¯",c:"èµ·æ²¹é‹çˆ†é¦™éº»è¾£é†¬ï¼ŒåŠ å…¥é«˜æ¹¯ç…®æ»¾ã€‚"}, {t:"æ·‹æ²¹çˆ†é¦™",c:"é­šç‰‡ç…®ç†Ÿç››ç›¤ã€‚å¦èµ·æ²¹é‹çˆ†é¦™èŠ±æ¤’ã€ä¹¾è¾£æ¤’ï¼Œæ·‹åœ¨é­šç‰‡ä¸Šã€‚"}],
                  tips: "å¤ªç™½ç²‰èƒ½è®“é­šè‚‰æ›´æ»‘å«©ï¼Œé†ƒè£½æ™‚åŠ ä¸€é»è›‹ç™½æ•ˆæœæ›´å¥½ã€‚", qa: [{q:"ä¸åƒè¾£?",a:"æ”¹ç•ªèŒ„æ¹¯åº•ã€‚"}], 
                  multiUse: [{id: 101, name:"éº»è¾£é‹",cost:"$30", img: "https://placehold.co/150x100/e74c3c/fff?text=Pot"},{id: 102, name:"å£æ°´é›",cost:"$50", img: "https://placehold.co/150x100/d35400/fff?text=Chicken"}],
                  comments: [{id:1, user:"ç‹å¤§å»š", star:5, date:"2å¤©å‰", text:"å®¢äººåæ‡‰å¾ˆå¥½ï¼Œå‡ºé¤å¾ˆå¿«ï¼"}, {id:2, user:"æåº—é•·", star:4, date:"1é€±å‰", text:"æˆæœ¬æ§åˆ¶å¾—å®œã€‚"}]
                },
                { id: 2, title: "æ³°å¼æ‰“æ‹‹è±¬", category: ["all","lazy","low_cost"], tags: ["#ç•°åœ‹æ–™ç†", "#ä¸‹é£¯ç¥å™¨"], type: "æ‡¶äººåŒ…", date: "2024/01/10", views: "5.8k", img: "./img/thai_pork.png",
                  stats: {time: "10åˆ†", cost: "$38", diff: "æ˜“"}, ranking: 2, reviews: 56, baseServings: 5, isSaved: false, note: "",
                  desc: "ä¸€é†¬æå®šè¤‡é›œèª¿å‘³ï¼Œé©åˆå•†æ¥­åˆé¤ã€‚",
                  ingredients: [ {name: "è±¬çµè‚‰", amount: 150, unit: "g"}, {name: "ä¹å±¤å¡”", amount: 1, unit: "æŠŠ"}, {name: "åº·å¯¶æ³°å¼æ‰“æ‹‹é†¬", amount: 2, unit: "å¤§åŒ™"}, {name: "é­šéœ²", amount: 1, unit: "å°åŒ™"}],
                  steps: [{t:"ç‚’çµè‚‰",c:"ç†±é‹çˆ†é¦™è’œæœ«ï¼ŒåŠ å…¥è±¬çµè‚‰ç‚’è‡³è®Šè‰²ã€‚"}, {t:"åŠ é†¬æ‹Œç‚’",c:"åŠ å…¥æ‰“æ‹‹é†¬æ‹Œå‹»ï¼Œèµ·é‹å‰æ”¾ä¹å±¤å¡”ã€‚"}],
                  tips: "å¤§ç«å¿«ç‚’æ‰æœ‰é‘Šæ°£ï¼Œçµè‚‰æ‰ä¸æœƒå‡ºæ°´ã€‚", qa: [{q:"ç”¨é›è‚‰?",a:"å¯ä»¥ã€‚"}],
                  multiUse: [{id: 103, name:"ç‚’æ²³ç²‰",cost:"$32", img:"https://placehold.co/150x100/2ecc71/fff?text=Noodle"}, {id: 104, name:"æ¶¼æ‹Œæµ·é®®",cost:"$45", img:"https://placehold.co/150x100/3498db/fff?text=Seafood"}], 
                  comments: [{id:3, user:"é™³å¸«å‚…", star:5, date:"3å¤©å‰", text:"çœŸçš„åªè¦ä¸€ç½é†¬ã€‚"}]
                },
                { id: 3, title: "å£æ°´é›", category: ["chef"], type: "åå»š", date: "2024/01/09", views: "2.1k", img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/recipes/TW-recipes/general/%E5%8F%A3%E6%B0%B4%E9%9B%9E/main-header.jpg", stats: {time: "20åˆ†", cost: "$60", diff: "ä¸­"}, ranking: 3, desc: "é®®é¦™éº»è¾£ã€‚", 
                  ingredients: [{name:"é›è…¿è‚‰",amount:2,unit:"æ”¯"},{name:"èŠ±ç”Ÿ",amount:50,unit:"g"},{name:"èŠ±æ¤’æ²¹",amount:2,unit:"å¤§åŒ™"}], 
                  steps: [{t:"ç…®é›",c:"é›è‚‰ç…®ç†Ÿå¾Œå†°é®åˆ‡å¡Šã€‚"},{t:"èª¿é†¬",c:"æ··åˆèª¿å‘³æ–™æ·‹åœ¨é›è‚‰ä¸Šã€‚"}], tips: "å†°é®æ˜¯çš®è„†è‚‰å«©çš„é—œéµã€‚", multiUse: [], comments: [] },
                { id: 4, title: "èˆ’è‚¥æ³¢ç‰¹é…’é¢¨å‘³é´¨èƒ¸", category: ["chef"], type: "åå»š", date: "2024/01/08", views: "1.5k", img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/recipes/TW-recipes/general/%E8%88%92%E8%82%A5%E6%B3%A2%E7%89%B9%E9%85%92%E9%A2%A8%E5%91%B3%E9%B4%A8%E8%83%B8%E4%B9%B3%E9%85%AA%E7%87%89%E9%A3%AF/main-header.jpg", stats: {time: "25åˆ†", cost: "$80", diff: "é›£"}, ranking: 4, desc: "æ¿ƒéƒæ¾éœ²é¦™ã€‚", 
                  ingredients: [{name:"ç¾©å¤§åˆ©ç±³",amount:200,unit:"g"},{name:"ç¶œåˆé‡è‡",amount:100,unit:"g"},{name:"æ¾éœ²é†¬",amount:1,unit:"å¤§åŒ™"}], 
                  steps: [{t:"ç‚’è‡",c:"é‡è‡ç‚’é¦™å‚™ç”¨ã€‚"},{t:"ç‡‰é£¯",c:"ç±³ç‚’é¦™å¾Œåˆ†æ¬¡åŠ å…¥é«˜æ¹¯ç‡‰ç…®ã€‚"}], tips: "é«˜æ¹¯è¦åˆ†æ¬¡åŠ æ‰èƒ½ç…®å‡ºæ¿ƒç¨ æ„Ÿã€‚", multiUse: [], comments: [] },
                { id: 5, title: "æ³•å¼æ´‹è”¥æ¹¯", category: ["chef"], type: "åå»š", date: "2024/01/07", views: "1.8k", img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/recipes/TW-recipes/general/%E6%B4%8B%E8%94%A5%E6%B9%AF/CR2024Beef002.jpg", stats: {time: "40åˆ†", cost: "$30", diff: "ä¸­"}, ranking: 5, desc: "ç¶“å…¸æ¹¯å“ã€‚", 
                  ingredients: [{name:"æ´‹è”¥",amount:3,unit:"é¡†"},{name:"ç‰›é«˜æ¹¯",amount:500,unit:"ml"},{name:"èµ·å¸",amount:50,unit:"g"}], 
                  steps: [{t:"ç‚’æ´‹è”¥",c:"å°ç«æ…¢ç‚’æ´‹è”¥è‡³ç„¦ç³–è‰²ã€‚"},{t:"ç…®æ¹¯",c:"åŠ å…¥é«˜æ¹¯ç…®æ»¾å¾Œç„—çƒ¤ã€‚"}], tips: "æ´‹è”¥ç‚’å¾—è¶Šä¹…è¶Šç”œã€‚", multiUse: [], comments: [] },
                { id: 101, title: "éº»è¾£é‹åº•", category: ["all"], type: "å»¶ä¼¸", date: "", img: "https://placehold.co/800x600/e74c3c/fff?text=Pot", stats: {time: "5åˆ†", cost: "$30", diff: "æ˜“"}, desc: "ä¸€é†¬æˆæ¹¯ã€‚", 
                  ingredients: [{name:"é«˜æ¹¯",amount:1000,unit:"ml"},{name:"éº»è¾£é†¬",amount:3,unit:"å¤§åŒ™"}], steps: [{t:"ç…®æ¹¯",c:"æ··åˆç…®æ»¾å³å¯ã€‚"}], tips: "", multiUse: [], comments: [] },
                { id: 102, title: "å£æ°´é›", category: ["all"], type: "å»¶ä¼¸", date: "", img: "https://placehold.co/800x600/d35400/fff?text=Chicken", stats: {time: "15åˆ†", cost: "$50", diff: "ä¸­"}, desc: "å†·ç›¤é¦–é¸ã€‚", 
                  ingredients: [{name:"é›è‚‰",amount:1,unit:"ä»½"},{name:"éº»è¾£é†¬",amount:1,unit:"åŒ™"}], steps: [{t:"æ·‹é†¬",c:"é†¬æ–™æ·‹åœ¨é›è‚‰ä¸Šã€‚"}], tips: "", multiUse: [], comments: [] },
                { id: 103, title: "ç‚’æ²³ç²‰", category: ["all"], type: "å»¶ä¼¸", date: "", img: "https://placehold.co/800x600/2ecc71/fff?text=Noodle", stats: {time: "8åˆ†", cost: "$32", diff: "æ˜“"}, desc: "Qå½ˆå¥½åƒã€‚", 
                  ingredients: [{name:"æ²³ç²‰",amount:200,unit:"g"},{name:"æ‰“æ‹‹é†¬",amount:1,unit:"åŒ™"}], steps: [{t:"å¿«ç‚’",c:"å¤§ç«ç‚’å‹»ã€‚"}], tips: "", multiUse: [], comments: [] },
                { id: 104, title: "æ¶¼æ‹Œæµ·é®®", category: ["all"], type: "å»¶ä¼¸", date: "", img: "https://placehold.co/800x600/3498db/fff?text=Seafood", stats: {time: "10åˆ†", cost: "$45", diff: "æ˜“"}, desc: "é…¸è¾£é–‹èƒƒã€‚", 
                  ingredients: [{name:"æµ·é®®",amount:100,unit:"g"},{name:"æ‰“æ‹‹é†¬",amount:1,unit:"åŒ™"}], steps: [{t:"æ‹Œå‹»",c:"æ‰€æœ‰ææ–™æ‹Œå‹»ã€‚"}], tips: "", multiUse: [], comments: [] },
            ],
            info: [
                { id: 101, title: "éŸ“å¼ç™¼é…µé†¬æ‡‰ç”¨è¶¨å‹¢", category: "trend", date: "2024/01/11", isNew: true, img: "https://placehold.co/800x600/eee/333?text=Korean+Sauce",
                  views: "1.2k", ranking: 1, tldr: ["å¯å–ä»£å‚³çµ±é†ƒæ–™","æˆæœ¬é™ä½30%"], isSaved: false,
                  content: `<p>è¿‘å¹´éŸ“å¼æ–™ç†é¢¨æ½®å¸­æ²å…¨çƒ...</p>` },
                { id: 102, title: "é›ç²‰å–ä»£é«˜æ¹¯æˆæœ¬è¡“", category: "manage", date: "2024/01/08", isNew: true, img: "https://placehold.co/800x600/333/fff?text=Chicken+Powder",
                  views: "3.5k", ranking: 2, tldr: ["å‚³çµ±ç†¬æ¹¯è²»æ™‚","é›ç²‰å³æ²–å³ç”¨"], isSaved: false, content: "å¯¦æ¸¬é¡¯ç¤º..." }
            ],
            products: [ 
                {name: "åº·å¯¶é®®é›æ±", img: "https://placehold.co/100/FFD700/333?text=Chicken"}, 
                {name: "åº·å¯¶éº»è¾£é†¬", img: "https://placehold.co/100/FF5700/FFF?text=Spicy"}, 
                {name: "åº·å¯¶æ‰“æ‹‹é†¬", img: "https://placehold.co/100/00652B/FFF?text=Thai"} 
            ],
            topProducts: [
                { id: 1, name: "åº·å¯¶é†‡æ¿ƒé›ç²‰", sales: "æœˆéŠ· 5,000+", img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/products/TW-products/packshots/knorr/%E5%BA%B7%E5%AF%B6%E9%9B%9E%E7%B2%89/%E9%9B%9E%E7%B2%89(1%E5%85%AC%E6%96%A4).png" },
                { id: 2, name: "åº·å¯¶æ¿ƒç¸®é®®é›æ±", sales: "æœˆéŠ· 3,500+", img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/products/TW-products/packshots/knorr/%E5%BA%B7%E5%AF%B6%E6%BF%83%E7%B8%AE%E9%AE%AE%E9%9B%9E%E6%B1%81/%E6%BF%83%E7%B8%AE%E9%AE%AE%E9%9B%9E%E6%B1%81(1%E5%85%AC%E6%96%A4).png" },
                { id: 3, name: "åº·å¯¶ç‘¤æŸ±é«˜æ¹¯", sales: "æœˆéŠ· 2,800+", img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/products/TW-products/packshots/knorr/%E5%BA%B7%E5%AF%B6%E7%91%A4%E6%9F%B1%E9%AB%98%E6%B9%AF/%E7%91%A4%E6%9F%B1%E9%AB%98%E6%B9%AF(480%E5%85%AC%E5%85%8B).png" },
                { id: 4, name: "åº·å¯¶æ¿ƒç™½é«˜æ¹¯å‡(é›è±¬é¢¨å‘³)", sales: "æœˆéŠ· 1,500+", img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/products/TW-products/packshots/knorr/%E5%BA%B7%E5%AF%B6%E6%BF%83%E7%99%BD%E9%AB%98%E6%B9%AF%E5%87%8D/%E6%BF%83%E7%99%BD%E9%AB%98%E6%B9%AF%E5%87%8D(800%E5%85%AC%E5%85%8B).png" }
            ],
            shopProducts: [
                {
                    id: 201, name: "åº·å¯¶é†‡æ¿ƒé›ç²‰", pack: "1kg x 12ç½/ç®±", price: "$3,600",
                    img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/products/TW-products/packshots/knorr/%E5%BA%B7%E5%AF%B6%E9%9B%9E%E7%B2%89/%E9%9B%9E%E7%B2%89(1%E5%85%AC%E6%96%A4).png",
                    desc: "96% å»šå¸«èªè­‰ï¼Œå£æ„Ÿæ¥è¿‘è€æ¯é›æ¹¯ï¼Œé©åˆå¿«ç‚’ã€é†ƒè£½ã€æ¹¯åº•ã€‚",
                    features: ["å«é›è‚‰æˆåˆ†", "æå‡é®®å‘³", "è€ç…®"]
                },
                {
                    id: 202, name: "åº·å¯¶æ¿ƒç¸®é®®é›æ±", pack: "1L x 6ç½/ç®±", price: "$2,100",
                    img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/products/TW-products/packshots/knorr/%E5%BA%B7%E5%AF%B6%E6%BF%83%E7%B8%AE%E9%AE%AE%E9%9B%9E%E6%B1%81/%E6%BF%83%E7%B8%AE%E9%AE%AE%E9%9B%9E%E6%B1%81(1%E5%85%AC%E6%96%A4).png",
                    desc: "æ¶²æ…‹é›ç²¾è¯ï¼Œå³æº¶å…ç…®ï¼Œé©åˆæ¶¼æ‹Œã€é»å¿ƒé¤¡æ–™ã€‚",
                    features: ["æ¶²æ…‹æ˜“æº¶", "é–ä½è‚‰æ±", "æé®®"]
                },
                {
                    id: 203, name: "åº·å¯¶ç‘¤æŸ±é«˜æ¹¯", pack: "480g x 6ç½/ç®±", price: "$2,400",
                    img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/products/TW-products/packshots/knorr/%E5%BA%B7%E5%AF%B6%E7%91%A4%E6%9F%B1%E9%AB%98%E6%B9%AF/%E7%91%A4%E6%9F%B1%E9%AB%98%E6%B9%AF(480%E5%85%AC%E5%85%8B).png",
                    desc: "ç²¾é¸ç‘¤æŸ±ç†¬è£½è€Œæˆçš„æ¿ƒç¸®æ¶²æ…‹é«˜æ¹¯",
                    features: ["å¹«åŠ©æå‡æµ·é®®æˆ–è”¬èœé¡çš„é®®ç”œåº¦", "ä¸€é†¬å¤šç”¨", "ç©©å®šå‡ºé¤"]
                },
                {
                    id: 204, name: "åº·å¯¶æ¿ƒç™½é«˜æ¹¯å‡(é›è±¬é¢¨å‘³)", pack: "800g x 6ç½/ç®±", price: "$1,800",
                    img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/products/TW-products/packshots/knorr/%E5%BA%B7%E5%AF%B6%E6%BF%83%E7%99%BD%E9%AB%98%E6%B9%AF%E5%87%8D/%E6%BF%83%E7%99%BD%E9%AB%98%E6%B9%AF%E5%87%8D(800%E5%85%AC%E5%85%8B).png",
                    desc: "ç¶“å…¸è¥¿å¼ç™½é†¬åŸºåº•ï¼Œå¥¶é¦™æ¿ƒéƒï¼ŒæŠ—ç†±æ€§ä½³ã€‚",
                    features: ["å¥¶é¦™æ¿ƒéƒ", "æŠ—ç†±æ€§ä½³", "ä¸æ˜“æ²¹æ°´åˆ†é›¢"]
                },
                {
                    id: 205, name: "åº·å¯¶æµ·é®®ç²‰", pack: "1kg x 12ç½/ç®±", price: "$3,800",
                    img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/products/TW-products/general/knorr-seafood-powder/Knorr_Seafood_Powder_1kg_Front_High_Res.png",
                    desc: "åš´é¸æµ·é®®ç²¾è¯ï¼Œæ¹¯é ­é®®ç”œï¼Œé©åˆæµ·é®®æ–™ç†ã€‚",
                    features: ["é®®ç”œæ¹¯é ­", "å»è…¥æé®®", "ç™¾æ­æµ·é®®"]
                },
                {
                    id: 206, name: "åº·å¯¶æ¿ƒç¸®ç•ªèŒ„éœœ", pack: "3kg x 6ç½/ç®±", price: "$4,200",
                    img: "https://www.unileverfoodsolutions.tw/dam/global-ufs/mcos/na/taiwan/calcmenu/products/TW-products/general/knorr-tomato-pronto/Knorr_Tomato_Pronto_3kg_Front_High_Res.png",
                    desc: "ç¾©å¤§åˆ©é€²å£ç•ªèŒ„ï¼Œé…¸ç”œé©ä¸­ï¼Œé©åˆç¾©å¤§åˆ©éºµã€ç‡‰é£¯ã€‚",
                    features: ["ç¾©å¤§åˆ©é€²å£", "é…¸ç”œé©ä¸­", "è‰²æ¾¤é®®ç´…"]
                }
            ],
            sop: { id:999, title:"3æ­¥é©Ÿå‡ºé¤ SOP", desc:"é‡å°ç¹å¿™å»šæˆ¿è¨­è¨ˆã€‚", steps:[{title:"å…èª¿å‘³",text:"ä½¿ç”¨å°ˆæ¥­é†¬æ–™"},{title:"é è£½",text:"çµ±ä¸€è¦æ ¼"},{title:"å¿«ç‚’",text:"å¤§ç«å‡ºé¤"}] },
            chef: { name:"æ±ŸæŒ¯èª ", desc:"ç±³å…¶æ—äºŒæ˜Ÿä¸»å»šï¼Œæ“…é•·é‹ç”¨åœ¨åœ°é£Ÿæï¼Œå°‡å‚³çµ±å·èœèˆ‡ç¾ä»£æŠ€æ³•çµåˆã€‚", img:"https://placehold.co/800x400/333/FFF?text=Chef+Andre" }
        };

        // --- Core Router ---
        function router(page) {
            if (userState === 'guest' && ['scan', 'profile'].includes(page)) {
                openReg();
                return;
            }
            document.querySelectorAll('.nav-item').forEach((el,i)=>el.classList.toggle('active', i===['home','info','scan','recipes','shop'].indexOf(page)));
            const root = document.getElementById('app-root');
            window.scrollTo(0,0);
            
            if(page==='home') root.innerHTML = renderHeader(page)+renderHome();
            else if(page==='info') root.innerHTML = renderHeader(page)+renderInfo();
            else if(page==='recipes') root.innerHTML = renderHeader(page)+renderRecipes();
            else if(page==='scan') renderScanPage();
            else if(page==='shop') root.innerHTML = renderHeader(page)+renderShop();
            else if(page==='profile') root.innerHTML = renderHeader(page)+renderProfile();
        }

        function renderHeader(page) {
            let tabs = page==='home'? '' :
                       page==='info'?renderTabs(['æœ€æ–°æƒ…å ±','ç¶“ç‡Ÿç®¡ç†','é¤é£²è¶¨å‹¢'],'info'):'';
            const profileAction = userState === 'guest' ? "openReg()" : "router('profile')";
            const profileIcon = `<span class="material-symbols-outlined icon-btn" onclick="${profileAction}">person</span>`;
            
            let guestChipsHTML = '';
            if (page === 'home' && userState === 'guest') {
                guestChipsHTML = `<div class="guest-chips-container">${guestInterests.map(i=>`<div class="guest-chip">${i}</div>`).join('')}</div>`;
            }
            return `<header><div class="header-top"><div class="search-bar"><span class="material-symbols-outlined">search</span>æœå°‹...</div><span class="material-symbols-outlined icon-btn">notifications</span>${profileIcon}</div>${guestChipsHTML}${tabs}</header>`;
        }
        function renderTabs(l,c) { return `<div class="tab-bar"><div class="scrolling-wrapper">${l.map((t,i)=>`<div class="tab-chip ${i===0?'active':''}" onclick="filterList(this,'${t}','${c}')">${t}</div>`).join('')}</div></div>`; }

        // --- Pages ---
        function renderHome() {
            let welcomeSection = '';
            
            if (userState === 'member') {
                let intentMsg = "ç‚ºä½ æ¨è–¦";
                if(userPrefs.goal === 'innovation') intentMsg = "âœ¨ æ¿€ç™¼ä½ çš„å»šè—éˆæ„Ÿ";
                else if(userPrefs.goal === 'efficiency') intentMsg = "âš¡ 3æ­¥é©Ÿå¿«é€Ÿå‡ºé¤æ–¹æ¡ˆ";
                else if(userPrefs.goal === 'cost') intentMsg = "ğŸ’° é«˜åˆ©æ½¤ä½æˆæœ¬é¦–é¸";

                welcomeSection = `<div style="padding:var(--space-lg) var(--space-md) 0;"><div style="font-size:var(--text-xs);color:var(--color-primary);font-weight:700;">ğŸ‘‹ æ—©å®‰ï¼Œå¼µä¸»å»š</div><div style="font-size:var(--text-2xl);font-weight:800;color:var(--color-text-main);">${intentMsg}</div></div>`;
            } else {
                welcomeSection = `<div style="padding:var(--space-lg) var(--space-md) 0;"><div style="font-size:var(--text-2xl);font-weight:800;color:var(--color-text-main);">æ¢ç´¢å°ˆæ¥­å»šè—æ–¹æ¡ˆ</div></div>`;
            }

            let hookCard = userState === 'guest'
                ? `<div class="hook-card fade-in" onclick="startWizard('change')">
                     <div class="hook-content">
                       <div class="hook-title">æ›èœéš¨èº«å¯¶</div>
                       <div class="hook-sub">è¼¸å…¥é¤å»³é¡å‹ï¼Œç²å¾—å°ˆå±¬èœå–®å»ºè­°</div>
                       <div style="margin-top:12px;background:white;color:#F57C00;padding:6px 16px;border-radius:20px;font-size:var(--text-xs);font-weight:700;display:inline-block;">é–‹å§‹æª¢æ¸¬</div>
                     </div>
                     <span class="material-symbols-outlined" style="font-size:80px;color:rgba(255,255,255,0.3);position:absolute;right:-10px;bottom:-10px;">restaurant_menu</span>
                   </div>`
                : '';

            return `
            <div class="fade-in">
                ${welcomeSection}
                ${hookCard}
                
                <div class="section-header"><div class="section-title"><span class="material-symbols-outlined" style="color:var(--color-secondary)">new_releases</span> 1æœˆæ–°èœä¸Šæ¶</div></div>
                <div class="card-scroll-container">${db.recipes.filter(r=>r.date.includes('01/1')).map(r=>renderCardV(r,true)).join('')}</div>
                
                <div class="section-header"><div class="section-title"><span class="material-symbols-outlined" style="color:#FFD700">emoji_events</span> ç†±é–€æ’è¡Œ</div></div>
                <div style="margin:0 var(--space-md);">
                    <div class="ranking-tabs">
                        <div class="ranking-tab active" onclick="switchRanking(this,'products')">åº·å¯¶äººæ°£ç†±éŠ·</div>
                        <div class="ranking-tab" onclick="switchRanking(this,'recipe')">å°ˆæ¥­é£Ÿè­œ</div>
                        <div class="ranking-tab" onclick="switchRanking(this,'info')">é¤é£²æƒ…å ±</div>
                    </div>
                    <div id="ranking-list">${renderRanking('products')}</div>
                </div>
                
                <div style="padding:var(--space-lg) var(--space-md);"><div onclick="openSOP()" style="background:linear-gradient(135deg,#6A1B9A,#4A148C);border-radius:var(--radius-lg);padding:24px;color:white;display:flex;align-items:center;gap:16px;box-shadow:var(--shadow-md);cursor:pointer;"><span class="material-symbols-outlined" style="font-size:32px;">bolt</span><div><div style="font-weight:700;font-size:var(--text-base);">3æ­¥é©Ÿå‡ºé¤ SOP</div><div style="font-size:var(--text-xs);opacity:0.8;">åˆé¤é«˜å³°æ•‘æ˜Ÿ</div></div></div></div>
            </div>`;
        }

        // --- Shop Page ---
        function renderShop() {
            const cats = ['å…¨å“é …', 'é®®å‘³èª¿æ–™', 'ä¸­å¼é†¬æ–™', 'è¥¿å¼é†¬æ±', 'æ¹¯ç²‰'];
            const catHtml = `<div class="tab-bar"><div class="scrolling-wrapper">${cats.map((c,i)=>`<div class="tab-chip ${i===0?'active':''}" onclick="this.parentElement.querySelectorAll('.tab-chip').forEach(el=>el.classList.remove('active'));this.classList.add('active');">${c}</div>`).join('')}</div></div>`;
            
            const gridHtml = db.shopProducts.map(p => {
                const priceDisplay = userState === 'member' ? p.price : "ç™»å…¥æŸ¥çœ‹æ‰¹ç™¼åƒ¹";
                const priceStyle = userState === 'member' ? 'color:var(--color-secondary);' : 'color:var(--color-primary);text-decoration:underline;cursor:pointer;';
                const priceAction = userState === 'member' ? '' : 'onclick="event.stopPropagation();openReg()"';

                return `
                <div class="card" onclick="openDetail('product',${p.id})">
                    <div class="card-img-wrapper" style="padding-top:100%;background:white;">
                        <img class="card-img" src="${p.img}" style="object-fit:contain;padding:20px;">
                    </div>
                    <div class="card-content">
                        <div class="card-title" style="font-size:14px;margin-bottom:4px;">${p.name}</div>
                        <div style="font-size:12px;color:#888;margin-bottom:8px;">${p.pack}</div>
                        <div style="font-weight:700;${priceStyle}" ${priceAction}>${priceDisplay}</div>
                    </div>
                </div>`;
            }).join('');

            return `
                <div class="fade-in">
                    ${catHtml}
                    <div class="recipe-grid" style="padding-top:16px;">
                        ${gridHtml}
                    </div>
                </div>
            `;
        }

        // Updated Profile Page
        function renderProfile() {
            return `
            <div class="fade-in">
                <div class="profile-bg">
                    <div class="profile-user">
                        <div class="profile-avatar">å¼µ</div>
                        <div>
                            <div style="font-size:var(--text-2xl);font-weight:700;">å¼µå¤§å»š</div>
                            <div style="font-size:var(--text-sm);opacity:0.9;background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:10px;display:inline-block;">é‡‘ç‰Œæœƒå“¡</div>
                        </div>
                    </div>
                </div>
                <div class="profile-card">
                    <div class="barcode-area" style="text-align: center; padding: var(--space-md) 0; border-bottom: 1px dashed var(--color-border); margin-bottom: var(--space-md);">
                        <div style="font-size:var(--text-xs);color:var(--color-text-muted);margin-bottom:8px;">æœƒå“¡æ¢ç¢¼ (é»æ“Šæ”¾å¤§)</div>
                        <img class="barcode-img" style="height:60px;opacity:0.8;" src="https://bwipjs-api.metafloor.com/?bcid=code128&text=123456789&height=10&scale=2&includetext" alt="barcode">
                    </div>
                    <div class="menu-grid">
                        <div class="menu-btn" onclick="alert('ç¥¨åˆ¸åŠŸèƒ½é–‹ç™¼ä¸­')">
                            <div class="menu-btn-icon"><span class="material-symbols-outlined">confirmation_number</span></div>
                            <div style="font-weight:700;">ç¥¨åˆ¸å¤¾</div>
                            <div style="font-size:11px;color:var(--color-text-muted);">0 å¼µå„ªæƒ åˆ¸</div>
                        </div>
                        <div class="menu-btn" onclick="openMyMenu()">
                            <div class="menu-btn-icon"><span class="material-symbols-outlined">favorite</span></div>
                            <div style="font-weight:700;">æˆ‘çš„èœå–®</div>
                            <div style="font-size:11px;color:var(--color-text-muted);">${db.recipes.filter(r=>r.isSaved).length} é“æ”¶è—</div>
                        </div>
                        <div class="menu-btn" onclick="alert('æ­·å²è¨‚å–®')">
                            <div class="menu-btn-icon"><span class="material-symbols-outlined">history</span></div>
                            <div style="font-weight:700;">æ­·å²è¨‚å–®</div>
                            <div style="font-size:11px;color:var(--color-text-muted);">è¿‘3å€‹æœˆ</div>
                        </div>
                        <div class="menu-btn" onclick="alert('å¸³è™Ÿè¨­å®š')">
                            <div class="menu-btn-icon"><span class="material-symbols-outlined">settings</span></div>
                            <div style="font-weight:700;">å¸³è™Ÿè¨­å®š</div>
                            <div style="font-size:11px;color:var(--color-text-muted);">ä¿®æ”¹è³‡æ–™</div>
                        </div>
                    </div>
                </div>
                
                <div class="support-btn" onclick="alert('é–‹å•Ÿç·šä¸Šå®¢æœè¦–çª—')">
                    <span class="material-symbols-outlined">support_agent</span> è¯ç¹«ç·šä¸Šå®¢æœ
                </div>
                
                <div class="logout-btn" onclick="logout()">
                    <span class="material-symbols-outlined">logout</span> ç™»å‡ºå¸³è™Ÿ
                </div>
            </div>`;
        }

        function openMyMenu() {
            const savedRecipes = db.recipes.filter(r => r.isSaved);
            document.getElementById('app-root').innerHTML = `
                <header><div class="header-top"><span class="material-symbols-outlined icon-btn" onclick="router('profile')">arrow_back</span><div style="flex:1;text-align:center;color:white;font-weight:700;">æˆ‘çš„èœå–®</div><span style="width:24px;"></span></div></header>
                <div class="fade-in" style="padding-top:var(--space-md);">
                    ${savedRecipes.length === 0 ? '<div style="text-align:center;padding:40px;color:#999;">é‚„æ²’æœ‰æ”¶è—ä»»ä½•é£Ÿè­œå–”ï¼</div>' : 
                      `<div class="recipe-grid">${savedRecipes.map(r=>renderCardV(r)).join('')}</div>`}
                </div>
            `;
        }

        function logout() {
            if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                userState = 'guest';
                alert('å·²ç™»å‡ºï¼Œå°‡è¿”å›é¦–é ');
                router('home');
            }
        }

        // --- Other Renderers ---
        function renderRecipes() {
            return `
                <div class="chef-banner fade-in" onclick="openChef()"><div style="z-index:1;"><div>ç±³å…¶æ—ä¸»å»š</div><div style="font-size:20px;font-weight:800;margin-top:4px;">æ±ŸæŒ¯èª  ç¨å®¶æˆæ¬Š</div></div><span class="material-symbols-outlined" style="font-size:48px;">restaurant_menu</span></div>
                <div class="strategy-cta-grid fade-in"><div class="strategy-btn btn-change" onclick="startWizard('change')"><div class="btn-icon-circle"><span class="material-symbols-outlined">restaurant_menu</span></div><span class="strategy-label">æˆ‘è¦æ›èœ</span><span class="strategy-sub">å­£ç¯€/ç¯€æ…¶</span></div><div class="strategy-btn btn-fast" onclick="startWizard('fast')"><div class="btn-icon-circle"><span class="material-symbols-outlined">timer</span></div><span class="strategy-label">å¿«é€Ÿå‡ºé¤</span><span class="strategy-sub">æ•ˆç‡/SOP</span></div></div>
                ${renderTabs(['å…¨éƒ¨','åå»šå°ˆå€','æ‡¶äººåŒ…','ä½æˆæœ¬'],'recipes')}
                <div id="recipe-list" class="recipe-grid fade-in">${db.recipes.map(r=>renderCardV(r)).join('')}</div>
            `;
        }
        function renderInfo() { return `<div id="info-list" class="fade-in" style="padding-top:var(--space-md);">${db.info.map(i=>renderListCard(i)).join('')}</div>`; }
        function renderScanPage() {
            document.getElementById('app-root').innerHTML = `
                <div class="scan-container fade-in">
                    <div class="scan-controls"><div class="toggle-btn" onclick="this.querySelector('.toggle-switch').classList.toggle('on')">é€£çºŒæƒææ¨¡å¼ <div class="toggle-switch"></div></div></div>
                    <div class="scan-viewfinder"><div class="scan-frame"></div><div class="toast" id="scan-toast"><span class="material-symbols-outlined">check_circle</span> æƒææˆåŠŸ +50é»</div><button onclick="simulateScan()" style="position:absolute;bottom:40px;background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.5);padding:8px 16px;border-radius:20px;cursor:pointer;">æ¨¡æ“¬æƒæ</button></div>
                    <div class="rewards-panel"><div class="progress-header"><span class="points-text">ç›®å‰: 850é»</span><span class="goal-text">å·® 150 é»æ› $100</span></div><div class="progress-track"><div class="progress-fill"></div></div><div style="font-size:14px;font-weight:700;margin-bottom:12px;">å¿«é€Ÿå…Œæ› (v19)</div><div class="instant-rewards"><div class="reward-card">ğŸª 7-11</div><div class="reward-card">ğŸ’¬ Line Pts</div></div></div>
                </div>`;
        }

        // --- Standard Logic & Helpers ---
        function filterList(el, filter, ctx) {
            el.parentElement.querySelectorAll('.tab-chip').forEach(c=>c.classList.remove('active')); el.classList.add('active');
            if(ctx==='recipes') {
                const k = {'å…¨éƒ¨':'all','åå»šå°ˆå€':'chef','æ‡¶äººåŒ…':'lazy','ä½æˆæœ¬':'low_cost'}[filter];
                document.getElementById('recipe-list').innerHTML = db.recipes.filter(r=>k==='all'||r.category.includes(k)).map(r=>renderCardV(r)).join('');
            } else if(ctx==='info') {
                const k = {'æœ€æ–°æƒ…å ±':'all','ç¶“ç‡Ÿç®¡ç†':'manage','é¤é£²è¶¨å‹¢':'trend'}[filter];
                document.getElementById('info-list').innerHTML = db.info.filter(i=>k==='all'||i.category===k).map(i=>renderListCard(i)).join('');
            } 
        }
        function switchRanking(el, type) {
            el.parentElement.querySelectorAll('.ranking-tab').forEach(c=>c.classList.remove('active')); el.classList.add('active');
            document.getElementById('ranking-list').innerHTML = renderRanking(type);
        }
        function simulateScan() { document.getElementById('scan-toast').classList.add('show'); setTimeout(()=>document.getElementById('scan-toast').classList.remove('show'),2000); }
        
        // ** Updated Grid Card: Conditional Save Button **
        function renderCardV(r, badgeDate=false) {
            const saveBtnHtml = userState === 'member' 
                ? `<div class="btn-save-mini card-save-pos ${r.isSaved?'active':''}" onclick="toggleSaveList(event, 'recipe', ${r.id})">
                     <span class="material-symbols-outlined">${r.isSaved?'favorite':'favorite_border'}</span>
                   </div>` 
                : '';

            return `
            <div class="card" onclick="openDetail('recipe',${r.id})">
                <div class="card-img-wrapper">
                    <div class="card-badge" style="${badgeDate?'background:var(--color-secondary)':''}">${r.type}</div>
                    ${saveBtnHtml}
                    <img class="card-img" src="${r.img}">
                </div>
                <div class="card-content">
                    <div class="card-title">${r.title}</div>
                    <div class="card-meta">
                        <span class="meta-tag">ğŸ’° ${r.stats.cost}</span>
                        <span class="meta-tag">â± ${r.stats.time}</span>
                        <span class="meta-tag">ğŸ”¥ ${r.stats.diff}</span>
                    </div>
                    <div class="card-bottom-info">
                        <span>${r.date}</span>
                        <span>â€¢</span>
                        <span><span class="material-symbols-outlined" style="font-size:10px;vertical-align:middle;">visibility</span> ${r.views}</span>
                    </div>
                </div>
            </div>`;
        }
        
        // ** Updated ListCard **
        function renderListCard(i, rank) {
            const saveBtnHtml = userState === 'member' && rank 
                ? `<div class="btn-save-mini ${i.isSaved?'active':''}" onclick="toggleSaveList(event, 'info', ${i.id})">
                     <span class="material-symbols-outlined">${i.isSaved?'favorite':'favorite_border'}</span>
                   </div>`
                : '';

            return `
            <div class="list-card" onclick="openDetail('info',${i.id})">
                ${rank?`<div class="rank-badge rank-${rank}">${rank}</div>`:''}
                <div style="flex:1;">
                    <div style="font-size:var(--text-xs);color:var(--color-primary);font-weight:700;">#${i.category.toUpperCase()} ${i.isNew?'<span style="color:var(--color-danger);">â— æ–°ä¸Šæ¶</span>':''}</div>
                    <div style="font-weight:700;margin-top:4px;">${i.title}</div>
                    <div class="ranking-meta-row">
                        <span>${i.date}</span>
                        <span>â€¢</span>
                        <span><span class="material-symbols-outlined" style="font-size:10px;vertical-align:middle;">visibility</span> ${i.views}</span>
                    </div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
                    <img class="list-card-img" src="${i.img}">
                    ${saveBtnHtml}
                </div>
            </div>`;
        }
        
        // ** Updated Ranking Logic: Save Button Removed from Ranking **
        function renderRanking(type) {
            if (type === 'products') {
                return db.topProducts.map((p, i) => `
                    <div class="list-card" onclick="openDetail('product', ${p.id})">
                        <div class="rank-badge rank-${i+1}">${i+1}</div>
                        <div style="flex:1;margin-left:8px;">
                            <div style="font-weight:700;">${p.name}</div>
                            <div style="font-size:var(--text-xs);color:var(--color-secondary);display:flex;align-items:center;gap:4px;margin-top:4px;">
                                <span class="material-symbols-outlined" style="font-size:14px;">local_fire_department</span>
                                ${p.sales}
                            </div>
                        </div>
                        <img class="list-card-img" src="${p.img}" style="object-fit:contain;padding:4px;background:#fff;border:1px solid #eee;">
                    </div>
                `).join('');
            } else if (type === 'recipe') {
                const list = db.recipes.slice(0,3);
                return list.map((r,i) => {
                    // Removed saveBtnHtml block here
                    return `
                    <div class="list-card" onclick="openDetail('recipe',${r.id})">
                        <div class="rank-badge rank-${i+1}">${i+1}</div>
                        <div style="flex:1; margin-left:8px; display:flex; flex-direction:column; justify-content:space-between;">
                            <div style="font-weight:700; line-height:1.3; margin-bottom:4px;">${r.title}</div>
                            <div class="card-meta" style="margin-top:0; margin-bottom:4px;">
                                <span class="meta-tag">ğŸ’° ${r.stats.cost}</span>
                                <span class="meta-tag">â± ${r.stats.time}</span>
                                <span class="meta-tag">ğŸ”¥ ${r.stats.diff}</span>
                            </div>
                            <div class="ranking-meta-row">
                                <span>${r.date}</span>
                                <span>â€¢</span>
                                <span><span class="material-symbols-outlined" style="font-size:10px;vertical-align:middle;">visibility</span> ${r.views}</span>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
                            <img class="list-card-img" src="${r.img}">
                        </div>
                    </div>`;
                }).join('');
            } else {
                const list = db.info.slice(0,3);
                // Also remove save button from Info ranking by passing rank=false or modifying renderListCard logic for ranking context?
                // renderListCard uses 'rank' parameter to decide on badge AND save button.
                // To keep it simple based on request "Remove collection from hot ranking", I'll modify renderRanking for info to NOT use the standard renderListCard or pass a flag to hide save button.
                // Let's manually render info ranking to be safe and clean.
                return list.map((i,idx) => `
                    <div class="list-card" onclick="openDetail('info',${i.id})">
                        <div class="rank-badge rank-${idx+1}">${idx+1}</div>
                        <div style="flex:1;">
                            <div style="font-size:var(--text-xs);color:var(--color-primary);font-weight:700;">#${i.category.toUpperCase()} ${i.isNew?'<span style="color:var(--color-danger);">â— æ–°ä¸Šæ¶</span>':''}</div>
                            <div style="font-weight:700;margin-top:4px;">${i.title}</div>
                            <div class="ranking-meta-row">
                                <span>${i.date}</span>
                                <span>â€¢</span>
                                <span><span class="material-symbols-outlined" style="font-size:10px;vertical-align:middle;">visibility</span> ${i.views}</span>
                            </div>
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
                            <img class="list-card-img" src="${i.img}">
                        </div>
                    </div>`).join('');
            }
        }
        
        function toggleSaveList(e, type, id) {
            e.stopPropagation(); 
            if(userState === 'guest') { return; } 
            
            const list = type === 'recipe' ? db.recipes : db.info;
            const item = list.find(x => x.id === id);
            
            if(item) {
                item.isSaved = !item.isSaved;
                if(document.querySelector('.nav-item.active').innerText.includes('é¦–é ')) {
                    document.getElementById('app-root').innerHTML = renderHeader('home') + renderHome();
                } else if(document.querySelector('.nav-item.active').innerText.includes('å°ˆæ¥­é£Ÿè­œ')) {
                    document.getElementById('recipe-list').innerHTML = db.recipes.map(r=>renderCardV(r)).join(''); 
                }
                const activeTab = document.querySelector('.ranking-tab.active');
                if(activeTab && document.getElementById('ranking-list')) {
                    const currentType = activeTab.innerText === 'å°ˆæ¥­é£Ÿè­œ' ? 'recipe' : 
                                        activeTab.innerText === 'é¤é£²æƒ…å ±' ? 'info' : 'products';
                     document.getElementById('ranking-list').innerHTML = renderRanking(currentType);
                }
            }
        }

        // --- Detail View Logic (Updated Footer) ---
        let currentRecipe = null;
        let currentPortion = 0;
        let editingCommentIndex = -1;

        function openDetail(type, id) {
            const footerSlot = document.getElementById('detail-footer-slot');
            document.getElementById('detail-view').style.display = 'block';
            document.body.style.overflow = 'hidden';

            if(type==='recipe') {
                currentRecipe = db.recipes.find(x=>x.id===id) || db.recipes[0];
                window.currentRecipeId = id;
                currentPortion = currentRecipe.baseServings || 10;
                renderRecipeDetail(currentRecipe);
                
                // Logic: Footer Buttons with Gate
                let footerContent = '';
                if(userState === 'member') {
                    const isSaved = currentRecipe.isSaved;
                    const saveBtnText = isSaved ? "å·²æ”¶è—" : "æ”¶è—";
                    const saveBtnIcon = isSaved ? "favorite" : "favorite_border";
                    footerContent = `
                        <button class="btn-outline" onclick="toggleSave()"><span class="material-symbols-outlined">${saveBtnIcon}</span> ${saveBtnText}</button>
                        <button class="btn-primary" onclick="goToProduct()"><span class="material-symbols-outlined">shopping_cart_checkout</span> é ˜è©¦ç”¨åŒ…</button>
                    `;
                } else {
                    // Guest: Only show "Get Trial"
                    footerContent = `
                        <button class="btn-primary" style="flex:1" onclick="openReg()"><span class="material-symbols-outlined">shopping_cart_checkout</span> é ˜è©¦ç”¨åŒ…</button>
                    `;
                }
                footerSlot.innerHTML = `<div class="detail-footer fade-in">${footerContent}</div>`;

            } else if (type === 'product') {
                let p = db.shopProducts.find(x => x.id === id);
                if (!p) p = db.topProducts.find(x => x.id === id);
                if(p && !p.desc) { 
                    p.desc = "åº·å¯¶å°ˆæ¥­é¤é£²ç³»åˆ—ï¼Œæä¾›ç©©å®šçš„å“è³ªèˆ‡é¢¨å‘³ã€‚"; 
                    p.features = ["ç©©å®šå‡ºé¤", "ç¯€çœå·¥æ™‚", "é¢¨å‘³æ¨™æº–åŒ–"];
                    p.pack = "è¦æ ¼è«‹æ´½æ¥­å‹™";
                    p.price = "åƒ¹æ ¼è«‹ç™»å…¥æŸ¥çœ‹";
                }

                // Price Logic for Detail
                const priceDisplay = userState === 'member' ? p.price : "ç™»å…¥æŸ¥çœ‹æ‰¹ç™¼åƒ¹";
                const priceStyle = userState === 'member' ? 'color:var(--color-secondary);' : 'color:var(--color-primary);text-decoration:underline;cursor:pointer;';
                const priceAction = userState === 'member' ? '' : 'onclick="openReg()"';

                document.getElementById('detail-img').src = p.img;
                document.getElementById('detail-img').style.objectFit = 'contain';
                document.getElementById('detail-img').style.padding = '40px';
                document.getElementById('detail-img').style.background = 'white';
                
                document.getElementById('detail-content').innerHTML = `
                    <div style="font-size:24px;font-weight:700;margin-bottom:8px;">${p.name}</div>
                    <div style="font-size:18px;font-weight:700;margin-bottom:16px;${priceStyle}" ${priceAction}>${priceDisplay}</div>
                    <div style="background:#f9f9f9;padding:16px;border-radius:12px;margin-bottom:24px;">
                        <div style="color:#666;font-size:13px;margin-bottom:4px;">åŒ…è£è¦æ ¼</div>
                        <div style="font-weight:700;">${p.pack}</div>
                    </div>
                    <h3 class="section-header-detail" style="margin-top:0;">ç”¢å“ä»‹ç´¹</h3>
                    <div style="line-height:1.6;color:#444;margin-bottom:24px;">${p.desc}</div>
                    
                    <h3 class="section-header-detail">ç”¢å“å„ªå‹¢</h3>
                    <ul style="padding-left:20px;color:#444;line-height:1.8;">
                        ${p.features ? p.features.map(f => `<li>${f}</li>`).join('') : ''}
                    </ul>
                `;
                
                // Footer Gate logic
                const action = userState === 'member' ? "alert('è¯çµ¡æ¥­å‹™/åŠ å…¥è³¼ç‰©è»Š...')" : "openReg()";
                
                footerSlot.innerHTML = `
                    <div class="detail-footer fade-in">
                        <button class="btn-outline" onclick="${action}"><span class="material-symbols-outlined">support_agent</span> è¯çµ¡æ¥­å‹™</button>
                        <button class="btn-primary" onclick="${action}"><span class="material-symbols-outlined">shopping_cart</span> ç«‹å³è³¼è²·</button>
                    </div>`;

            } else {
                renderInfoDetail(db.info.find(x=>x.id===id));
                footerSlot.innerHTML = '';
            }
        }

        function renderRecipeDetail(r) {
            document.getElementById('detail-img').src = r.img;
            document.getElementById('detail-img').style.objectFit = 'cover';
            document.getElementById('detail-img').style.padding = '0';
            const ingHtml = generateIngredientList(r.ingredients, r.baseServings || 10, currentPortion);

            // Conditional Note Section for Members
            let noteHtml = '';
            if(userState === 'member') {
                noteHtml = `
                <div style="background:#f0f7f2; padding:16px; border-radius:12px; margin:24px 0;">
                    <div style="font-weight:700; display:flex; align-items:center; gap:8px;">
                        <span class="material-symbols-outlined" style="color:var(--color-primary)">edit_note</span> 
                        ğŸ‘¨â€ğŸ³ æˆ‘çš„ç­†è¨˜
                    </div>
                    <textarea class="note-area" id="recipe-note" placeholder="è¨˜éŒ„èª¿æ•´çš„å£å‘³ã€æˆæœ¬æˆ–å¿ƒå¾—...">${r.note || ''}</textarea>
                    <button class="btn-save-note" onclick="saveNote()">å„²å­˜ç­†è¨˜</button>
                    <div style="clear:both;"></div>
                </div>`;
            }

            const html = `
                <div style="font-size:var(--text-3xl);font-weight:700;">${r.title}</div>
                <div class="tag-row">${r.tags ? r.tags.map(t=>`<span class="detail-tag">${t}</span>`).join('') : ''}</div>
                <div class="info-grid"><div class="info-box"><div class="info-label">æˆæœ¬</div><div class="info-value">${r.stats.cost}</div></div><div class="info-box"><div class="info-label">æ™‚é–“</div><div class="info-value">${r.stats.time}</div></div><div class="info-box"><div class="info-label">é›£åº¦</div><div class="info-value">${r.stats.diff}</div></div></div>
                
                ${noteHtml}

                <h3 class="section-header-detail">æ‰€éœ€ææ–™ <span style="font-size:var(--text-xs);color:var(--color-text-muted);font-weight:400;margin-left:auto;">å¯ä¾äººæ•¸èª¿æ•´</span></h3>
                
                <div class="portion-control">
                    <div class="portion-btn" onclick="updatePortion(-1)">-</div>
                    <div class="portion-display">
                        <span id="portion-val">${currentPortion}</span>
                        <span class="portion-label">äººä»½</span>
                    </div>
                    <div class="portion-btn" onclick="updatePortion(1)">+</div>
                </div>

                <div class="ing-group" id="ing-list">${ingHtml}</div>
                
                <h3 class="section-header-detail">çƒ¹èª¿æ­¥é©Ÿ</h3>
                ${r.steps && r.steps.length > 0 ? r.steps.map((s,i)=>`<div class="step-row" style="margin-bottom:var(--space-md);display:flex;gap:12px;"><div class="step-idx" style="background:var(--color-primary);color:white;width:24px;height:24px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:var(--text-xs);flex-shrink:0;">${i+1}</div><div style="flex:1;"><div style="font-weight:700;margin-bottom:4px;">${s.t}</div><div style="color:var(--color-text-body);">${s.c}</div></div></div>`).join('') : '<div style="color:#999;">æš«ç„¡æ­¥é©Ÿ</div>'}
                
                <div style="background:#FFF3E0;padding:16px;border-radius:var(--radius-lg);margin:var(--space-md) 0;display:flex;gap:12px;align-items:start;"><span class="material-symbols-outlined" style="color:#E65100">lightbulb</span> <div><strong>ä¸»å»š Tipsï¼š</strong> ${r.tips || "ç„¡"}</div></div>

                <div class="comment-section">
                    <div class="section-title" style="padding-left:0;">ä¸»å»šè©•è«–å€</div>
                    <div id="comments-container">${renderComments(r.comments)}</div>
                    <div class="comment-input-area">
                        <input type="text" id="comment-input" class="comment-input" style="width:100%;border:none;background:transparent;outline:none;font-size:var(--text-sm);" placeholder="åˆ†äº«æ‚¨çš„è©¦åšå¿ƒå¾—...">
                        <button class="btn-submit" id="btn-comment-submit" onclick="submitComment()"><span class="material-symbols-outlined" style="font-size:18px;">send</span></button>
                    </div>
                </div>
                
                <h3 class="section-header-detail">æ¨è–¦å•†å“</h3>
                <div class="product-rec-container">
                    ${db.products.map(p=>`<div class="product-card-sm"><img src="${p.img}"><div style="font-weight:700;font-size:var(--text-sm);">${p.name}</div><span class="material-symbols-outlined" style="margin-left:auto;color:#ccc;">chevron_right</span></div>`).join('')}
                </div>`;
            document.getElementById('detail-content').innerHTML = html;
        }

        function renderInfoDetail(i) {
            document.getElementById('detail-img').src = i.img;
            document.getElementById('detail-content').innerHTML = `<div style="font-size:var(--text-2xl);font-weight:700;margin-bottom:12px;">${i.title}</div><div style="line-height:1.8;">${i.content}</div>`;
        }

        function saveNote() {
            const txt = document.getElementById('recipe-note').value;
            currentRecipe.note = txt;
            alert('ç­†è¨˜å·²å„²å­˜');
        }

        function updatePortion(delta) {
            const newP = currentPortion + delta;
            if(newP < 1) return;
            currentPortion = newP;
            document.getElementById('portion-val').innerText = currentPortion;
            document.getElementById('ing-list').innerHTML = generateIngredientList(currentRecipe.ingredients, currentRecipe.baseServings || 10, currentPortion, true);
        }

        function generateIngredientList(ingredients, baseP, currP, animate=false) {
            if (!ingredients || ingredients.length === 0) return '<div style="color:var(--color-text-muted);">æš«ç„¡é£Ÿæè³‡è¨Š</div>';
            return ingredients.map(ing => {
                const newAmount = Math.round((ing.amount / baseP) * currP * 10) / 10;
                return `
                <div class="checkbox-item" onclick="this.querySelector('.checkbox-circle').classList.toggle('checked')">
                    <div class="checkbox-left">
                        <div class="checkbox-circle"></div>
                        <span>${ing.name}</span>
                    </div>
                    <div class="ing-amount ${animate?'changed':''}">${newAmount} ${ing.unit}</div>
                </div>`;
            }).join('');
        }

        function renderComments(comments) {
            if(!comments||!comments.length) return '<div style="color:var(--color-text-muted);font-size:13px;">å°šç„¡è©•è«–ã€‚</div>';
            return comments.map((c,i) => `
                <div class="comment-item">
                    <div class="comment-avatar">${c.user[0]}</div>
                    <div class="comment-body">
                        <div class="comment-name">${c.user}</div>
                        <div class="comment-meta"><span class="comment-stars">${'â˜…'.repeat(c.star)}</span> <span>${c.date}</span></div>
                        <div class="comment-text">${c.text}</div>
                        <div class="comment-actions">
                            ${c.user==='æˆ‘'?`
                                <div class="action-chip" onclick="editComment(${i})"><span class="material-symbols-outlined" style="font-size:14px;">edit</span> ç·¨è¼¯</div>
                                <div class="action-chip" onclick="delCom(${i})"><span class="material-symbols-outlined" style="font-size:14px;">delete</span> åˆªé™¤</div>
                            `:`<div class="action-chip"><span class="material-symbols-outlined" style="font-size:14px;">thumb_up</span> æœ‰å¹«åŠ©</div>`}
                        </div>
                    </div>
                </div>`).join('');
        }

        function submitComment() {
            if(userState === 'guest') { openReg(); return; }
            const input = document.getElementById('comment-input');
            const txt = input.value.trim();
            if(!txt) return;

            const r = db.recipes.find(x=>x.id===window.currentRecipeId);
            
            if(editingCommentIndex > -1) {
                r.comments[editingCommentIndex].text = txt;
                r.comments[editingCommentIndex].date = "å·²ç·¨è¼¯";
                editingCommentIndex = -1;
                document.getElementById('btn-comment-submit').classList.remove('editing');
                document.getElementById('btn-comment-submit').innerHTML = '<span class="material-symbols-outlined" style="font-size:18px;">send</span>';
            } else {
                r.comments.unshift({user:"æˆ‘",star:5,text:txt,date:"å‰›å‰›"});
            }
            input.value = '';
            document.getElementById('comments-container').innerHTML = renderComments(r.comments);
        }

        function editComment(idx) {
            const r = db.recipes.find(x=>x.id===window.currentRecipeId);
            const comment = r.comments[idx];
            document.getElementById('comment-input').value = comment.text;
            document.getElementById('comment-input').focus();
            editingCommentIndex = idx;
            const btn = document.getElementById('btn-comment-submit');
            btn.classList.add('editing');
            btn.innerHTML = '<span class="material-symbols-outlined" style="font-size:18px;">check</span>';
        }

        function delCom(i) { 
            if(confirm('ç¢ºå®šè¦åˆªé™¤ç•™è¨€ï¼Ÿ')) {
                const r=db.recipes.find(x=>x.id===window.currentRecipeId); 
                r.comments.splice(i,1); 
                document.getElementById('comments-container').innerHTML=renderComments(r.comments); 
                if(i === editingCommentIndex) {
                    editingCommentIndex = -1;
                    document.getElementById('comment-input').value = '';
                    document.getElementById('btn-comment-submit').classList.remove('editing');
                }
            }
        }

        function goToProduct() { 
             if(userState === 'guest') { openReg(); return; }
             alert('å‰å¾€ç›¸é—œå•†å“é é¢...'); 
        }

        // --- Wizard Logic ---
        let wizardState = { type: null, step: 0, selections: [], path: null };
        function startWizard(type) { 
            wizardState = { type, step: 0, selections: [], path: null }; 
            document.getElementById('wizard-title').innerText = type === 'change' ? "æˆ‘è¦æ›èœ" : "å¿«é€Ÿå‡ºé¤";
            renderWizardStep(); 
            document.getElementById('wizard-content').style.display = 'block'; 
            document.getElementById('wizard-loading').style.display = 'none'; 
            document.getElementById('wizard-overlay').style.display = 'flex'; 
        }

        function renderWizardStep() {
            let q = "", o = [];
            if (wizardState.type === 'change') {
                if (wizardState.step === 0) { q = "è«‹å•æ‚¨æƒ³ä¸»æ‰“ä»€éº¼ï¼Ÿ"; o = ["å­£ç¯€é™å®š", "ç¯€æ…¶ç‰¹é¤"]; } 
                else if (wizardState.step === 1) { 
                    if (wizardState.selections[0] === "å­£ç¯€é™å®š") { q = "é¸æ“‡æœˆä»½"; o = ["1~3æœˆ (æ˜¥)", "4~6æœˆ (å¤)", "7~9æœˆ (ç§‹)", "10~12æœˆ (å†¬)"]; } 
                    else { q = "é¸æ“‡ç¯€æ…¶"; o = ["éå¹´", "æ¯è¦ªç¯€", "ç«¯åˆç¯€", "ä¸­ç§‹ç¯€"]; }
                } 
                else if (wizardState.step === 2) { q = "é¸æ“‡æ ¸å¿ƒé£Ÿæ"; o = ["é›è‚‰", "è±¬è‚‰", "ç‰›è‚‰", "æµ·é®®"]; } 
                else if (wizardState.step === 3) { q = "é¸æ“‡èœç³»é¢¨æ ¼"; o = ["ä¸­å¼", "è¥¿å¼", "æ—¥å¼", "æ³°å¼"]; }
            } else {
                if (wizardState.step === 0) { q = "ç›®æ¨™å‡ºé¤æ™‚é–“"; o = ["3 åˆ†é˜å…§", "5 åˆ†é˜å…§", "10 åˆ†é˜å…§"]; } 
                else if (wizardState.step === 1) { q = "ç¾æœ‰çƒ¹èª¿è¨­å‚™"; o = ["å¿«é€Ÿçˆ", "è’¸çƒ¤ç®±", "æ²¹ç‚¸é‹"]; }
            }
            document.getElementById('wizard-content').innerHTML = `<div style="text-align:center;"><div style="font-size:20px;font-weight:700;margin-bottom:24px;">${q}</div><div class="wizard-option-grid">${o.map(opt => `<div class="wizard-option" onclick="handleOptionClick('${opt}')">${opt}</div>`).join('')}</div></div>`; 
            let totalSteps = wizardState.type === 'change' ? 4 : 2;
            document.getElementById('wizard-progress').innerHTML = Array(totalSteps).fill(0).map((_,i)=>`<div class="progress-bar ${i<=wizardState.step?'active':''}"></div>`).join('');
        }

        function handleOptionClick(sel) { 
            wizardState.selections.push(sel); 
            let totalSteps = wizardState.type === 'change' ? 4 : 2;
            if (wizardState.step < totalSteps - 1) { wizardState.step++; renderWizardStep(); } 
            else { 
                document.getElementById('wizard-content').style.display = 'none'; 
                document.getElementById('wizard-loading').style.display = 'block'; 
                setTimeout(() => { closeWizard(); renderRecommendationResults(wizardState.selections); }, 1500); 
            } 
        }
        function closeWizard() { document.getElementById('wizard-overlay').style.display = 'none'; }
        function renderRecommendationResults(tags) {
            document.getElementById('app-root').innerHTML = `
                <header><div class="header-top"><span class="material-symbols-outlined icon-btn" onclick="router('recipes')">arrow_back</span><div style="flex:1;text-align:center;color:white;font-weight:700;">æ¨è–¦çµæœ</div><span style="width:24px;"></span></div></header>
                <div class="result-context fade-in"><div class="result-context-title"><span class="material-symbols-outlined" style="font-size:18px;">auto_awesome</span> ç‚ºæ‚¨æ¨è–¦ 10 é“æœ€ä½³æ–¹æ¡ˆ</div><div class="result-chips">${tags.map(t => `<div class="result-chip">${t}</div>`).join('')}</div></div>
                <div class="recipe-grid fade-in" style="padding-top:0;">${db.recipes.map(r => renderCardV(r)).join('')}</div>`;
            window.scrollTo(0,0);
        }

        // --- Reg Logic (Intent First) ---
        let regStep = 'login';
        function openReg() { regStep = 'login'; renderRegStep(); document.getElementById('reg-overlay').style.display = 'flex'; }
        function closeReg() { document.getElementById('reg-overlay').style.display = 'none'; }
        
        function renderRegStep() {
            const container = document.getElementById('reg-step-container');
            let content = '';
            if(regStep === 'login') {
                content = `<div style="text-align:center;margin-bottom:24px;"><h2 style="font-size:24px;font-weight:800;margin-bottom:8px;">ç™»å…¥ / è¨»å†Š</h2><p style="color:var(--color-text-muted);font-size:14px;">è§£é–å°ˆæ¥­é£Ÿè­œèˆ‡é›†é»åŠŸèƒ½</p></div><button class="btn-social btn-apple" onclick="proceedToSurvey()"><span class="material-symbols-outlined"></span> ä½¿ç”¨ Apple ç™»å…¥</button><button class="btn-social btn-line" onclick="proceedToSurvey()"><span class="material-symbols-outlined">chat_bubble</span> ä½¿ç”¨ Line ç™»å…¥</button><button class="btn-social btn-phone" onclick="goToPhoneInput()"><span class="material-symbols-outlined">smartphone</span> æ‰‹æ©Ÿè™Ÿç¢¼ç™»å…¥</button><div style="text-align:center;margin-top:24px;font-size:12px;color:var(--color-text-muted);">ç™»å…¥å³ä»£è¡¨æ‚¨åŒæ„ <span style="text-decoration:underline;">æœå‹™æ¢æ¬¾</span> èˆ‡ <span style="text-decoration:underline;">éš±ç§æ¬Šæ”¿ç­–</span></div>`;
            } else if(regStep === 'phone') {
                content = `<div style="font-weight:700;margin-bottom:16px;">è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼</div><input type="tel" class="reg-input" placeholder="09xx-xxx-xxx" value="0912-345-678"><button class="btn-reg-action" onclick="proceedToSurvey()">ç™¼é€é©—è­‰ç¢¼</button><div style="text-align:center;margin-top:16px;font-size:14px;color:var(--color-primary);cursor:pointer;" onclick="openReg()">è¿”å›é¸æ“‡å…¶ä»–æ–¹å¼</div>`;
            } else if(regStep === 1) {
                content = `<div style="text-align:center;margin-bottom:24px;"><span class="material-symbols-outlined" style="font-size:48px;color:var(--color-success);">check_circle</span><h3 style="margin-top:8px;">ç™»å…¥æˆåŠŸï¼</h3><p style="color:var(--color-text-muted);font-size:14px;">æœ€å¾Œä¸€æ­¥ï¼Œè®“æˆ‘å€‘ç‚ºæ‚¨è¨‚è£½é¦–é å…§å®¹</p></div><div style="font-weight:700;margin-bottom:16px;">æ‚¨ç›®å‰æœ€æƒ³è§£æ±ºçš„é›£é¡Œæ˜¯ï¼Ÿ</div><div style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px;"><div class="survey-card" onclick="setGoal('innovation')"><div class="survey-icon"><span class="material-symbols-outlined">lightbulb</span></div><div class="survey-text-group"><div class="survey-title">é–‹ç™¼æ–°èœè‰²</div><div class="survey-sub">å°‹æ‰¾éˆæ„Ÿã€åå»šæŠ€æ³•</div></div></div><div class="survey-card" onclick="setGoal('efficiency')"><div class="survey-icon"><span class="material-symbols-outlined">speed</span></div><div class="survey-text-group"><div class="survey-title">æå‡å‡ºé¤æ•ˆç‡</div><div class="survey-sub">æ¨™æº–åŒ– SOPã€æ‡¶äººåŒ…</div></div></div><div class="survey-card" onclick="setGoal('cost')"><div class="survey-icon"><span class="material-symbols-outlined">savings</span></div><div class="survey-text-group"><div class="survey-title">é™ä½é£Ÿææˆæœ¬</div><div class="survey-sub">é«˜åˆ©æ½¤ã€ä¸€é†¬å¤šç”¨</div></div></div></div>`;
            } else if(regStep === 2) {
                content = `<div style="font-weight:700;margin-bottom:16px;">è«‹å•æ‚¨çš„é¤å»³é¡å‹æ˜¯ï¼Ÿ</div><div class="wizard-option-grid" style="margin-bottom:16px;">${['ä¸­å¼ç†±ç‚’','è¥¿å¼é¤é…’é¤¨','è‡ªåŠ©é¤/ä¾¿ç•¶','ç«é‹åº—'].map(t=>`<div class="wizard-option" onclick="nextRegStep()">${t}</div>`).join('')}</div>`;
            }
            container.innerHTML = content;
        }
        
        function goToPhoneInput() { regStep = 'phone'; renderRegStep(); }
        function proceedToSurvey() { regStep = 1; renderRegStep(); }
        function setGoal(goal) { userPrefs.goal = goal; nextRegStep(); }
        function nextRegStep() {
            if(regStep === 1) regStep = 2;
            else if(regStep === 2) finishReg();
            if(regStep !== 'finish') renderRegStep();
        }
        function finishReg() {
            userState = 'member';
            closeReg();
            let msg = "æ­¡è¿ï¼å·²ç‚ºæ‚¨è§£é–å°ˆæ¥­åŠŸèƒ½";
            if(userPrefs.goal === 'innovation') msg = "æ­¡è¿ï¼å·²ç‚ºæ‚¨æº–å‚™å¥½åå»šéˆæ„Ÿå°ˆå€ âœ¨";
            else if(userPrefs.goal === 'efficiency') msg = "æ­¡è¿ï¼å¿«é€Ÿå‡ºé¤æ–¹æ¡ˆå·²æº–å‚™å°±ç·’ âš¡";
            alert(msg);
            router('home');
        }

        function openSOP() {
            const s = db.sop;
            document.getElementById('detail-img').src = s.img;
            document.getElementById('detail-content').innerHTML = `<div style="font-size:24px;font-weight:700;">${s.title}</div><div style="background:var(--color-info);padding:16px;border-radius:12px;margin:16px 0;color:var(--color-info-text);">${s.desc}</div>${s.steps.map((st,i)=>`<div style="margin-bottom:16px;"><div style="font-weight:700;">${i+1}. ${st.title}</div><div style="font-size:13px;color:#666;">${st.text}</div></div>`).join('')}`;
            document.getElementById('detail-footer-slot').innerHTML = ''; 
            document.getElementById('detail-view').style.display='block';
        }
        function openChef() {
            const c = db.chef;
            document.getElementById('detail-img').src = c.img;
            const chefRecipes = db.recipes.filter(r => r.type === 'åå»š');
            document.getElementById('detail-content').innerHTML = `<div style="font-size:24px;font-weight:700;">${c.name}</div><div style="margin-top:16px;color:#555;">${c.desc}</div><h3 class="section-header-detail">ä¸»å»šæ¨è–¦é£Ÿè­œ (${chefRecipes.length})</h3><div class="recipe-grid" style="padding:0;">${chefRecipes.map(r=>renderCardV(r)).join('')}</div>`;
            document.getElementById('detail-footer-slot').innerHTML = ''; 
            document.getElementById('detail-view').style.display='block';
        }
        function closeDetail() { document.getElementById('detail-view').style.display = 'none'; document.body.style.overflow = 'auto'; }
        function updateProgress() { const el = document.getElementById('detail-view'); document.getElementById('read-progress').style.width = (el.scrollTop / (el.scrollHeight - el.clientHeight)) * 100 + '%'; }

        router('home');
    </script>
</body>
</html>